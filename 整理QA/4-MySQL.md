# MySQL数据库

**Q:说一说MySQL的事务。**  
A:事务指的是对数据库中数据的一系列操作要么都成功，要么都失败。  
MySQL中MyISM存储引擎是不支持事务的，InnoDB是支持事务的。  
想要做到这点，一个数据库事务要满足ACID四个特性。
原子性保证不可分割。一致性要求事务发生前后数据都要完整。隔离性保证事务不能被其他事务干扰。持久性保证对数据的改变是永久性的。
  
如果在没有事务隔离的时候，对数据的读取会出现脏读、幻读和不可重复读。  
脏读：A读取到了B修改但是没有提交的数据。  
幻读：A多次读取的过程中被B修改掉了，A多次读取的结果的数量不一样。针对的是插入或者删除。  
不可重复读：A多次读取的过程中被B修改掉了，A多次读取的结果值不一样。针对的是修改。 
   
而一般数据库的隔离级别有四种：  
读未提交：是最低的级别，不能避免脏读、幻读和不可重复读。  
读已提交：是Oracle默认的隔离级别，可以避免脏读。  
可重复读：是MySQL默认的隔离级别，可以避免脏读和不可重复读。  
序列化：可以避免脏读幻读和不可重复读。  
  
另外数据库一般都有7种传播行为，什么是传播行为，也就是一个事务遇到另一个事务，改如何控制：  
常用的是下面这两种：  
propagation_required 需要传播 如果当前没有事务，就创建一个新事务，如果当前存在事务，就加入该事务     
propagation_supports 支持传播 如果当前存在事务，就加入该事务，如果当前不存在事务，就以非事务执行    
   
  
**Q：说一说在开发过程中事务失效的场景。**  
A：在项目中，一般用@Transactional注解去标识事务方法。事务失效的场景有：  
1、使用事务方法没有被Spring管理。  
2、方法不是public的。  
3、自身调用问题，没有使用事务的方法调用使用事务的方法，或者事务方法调用了一个新开事务的方法，这些情况事务都不会起作用。  
4、数据源没有配置Spring的事务管理器。  
5、注解上使用了不支持事务的传播行为。  
6、异常被catch也会使得事务失效。  
7、异常类型错误，默认回滚的是RunTimeException，想要让抛出异常事务回滚，则需要在事务注解上标注Throwable异常类及其子类。  
  

**Q：说说MySQL数据库的索引。**  
A：数据库的索引是帮助高效获取数据的数据结构。数据库除了数据本身之外，还会维护着一个索引的数据结构。MySQL的索引是用B+树去做的。比如说主键索引就是一种会随着表一起建立的主键索引。  
一般在选择在where中的外键关联字段，经常统计、分组和排序的字段应该建立索引。  
对于表记录比较少，经常会增删改的表，或者是where字句中用不到的字段，这些情况建立索引反而会因为维护索引而降低性能。  
  
**Q:怎么对SQL做性能分析？**
A: 可以使用 explain + sql语句去看 这条SQL执行的情况。  
主要关注的结果列有：   
key列 如果是null,表示没有用到索引。  
rows列 表示这条语句必须检查的行数，如果基本等于表的长度，也不太好。  
type列 如果是all的话表示进行了全表的扫描，也不太行。起码要达到range，就是用到了索引。  
还有最重要的是看extra这一列 如果是出现了Using filesort 文件内排序、Using temporary 临时表(对查询结果进行了排序)说明索引走的情况不是很好。要进行优化了。  
   
**Q:说一些索引失效的场景。**  
A:没有遵守最左前缀原则，使用了is null、不等于、大于小于、索引列上进行了计算、like的通配符写在了最前面、字符串不加单引号，这些情况都会使得索引失效。    
  
  
**Q:生产上是怎么分析的。**  
A:首先是开启数据库的慢查询日志，比如说超过2秒钟的就是慢SQL。   
配置文件里面的那个参数 show_query_log开启日志。设置慢查询的阈值 long_query_time = 2;  
拿到了这些SQL之后可以用explain 在数据中分析。  
还可以用日志分析命令show profile查询SQL在服务器里面的执行细节。  























